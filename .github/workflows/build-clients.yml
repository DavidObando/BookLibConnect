name: Build Clients

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - runtime: osx-arm64
            label: macOS-ARM64
            runner: macos-latest
          - runtime: osx-x64
            label: macOS-x64
            runner: macos-latest

    name: Build ${{ matrix.label }}
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Import code signing certificate
        if: env.HAS_CERT == 'true'
        env:
          HAS_CERT: ${{ secrets.MACOS_CERTIFICATE_P12 != '' }}
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          # Decode the certificate
          CERT_FILE=$(mktemp /tmp/cert.XXXXXX.p12)
          echo "$MACOS_CERTIFICATE_P12" | base64 --decode > "$CERT_FILE"

          # Create a temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import the certificate
          security import "$CERT_FILE" \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add the keychain to the search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          rm "$CERT_FILE"

          # Extract the signing identity name
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "CODESIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "Found signing identity: $IDENTITY"

      - name: Restore dependencies
        working-directory: src
        run: dotnet restore Oahu.Avalonia.slnf

      - name: Build
        working-directory: src
        run: dotnet build Oahu.Avalonia.slnf --configuration Release --no-restore

      - name: Create .app bundle, sign, and create DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          SIGN_ARGS=""
          if [[ -n "${CODESIGN_IDENTITY:-}" ]]; then
            SIGN_ARGS="--codesign-identity \"$CODESIGN_IDENTITY\""
          fi

          NOTARIZE_ARGS=""
          if [[ "$GITHUB_EVENT_NAME" != "pull_request" && -n "${APPLE_ID:-}" && -n "${APPLE_ID_PASSWORD:-}" && -n "${APPLE_TEAM_ID:-}" && -n "${CODESIGN_IDENTITY:-}" ]]; then
            NOTARIZE_ARGS="--notarize --apple-id \"$APPLE_ID\" --apple-id-password \"$APPLE_ID_PASSWORD\" --apple-team-id \"$APPLE_TEAM_ID\""
          fi

          eval ./build/build-macos.sh \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --output ./artifacts \
            $SIGN_ARGS \
            $NOTARIZE_ARGS

      - name: Cleanup keychain
        if: always()
        run: |
          if [[ -n "${KEYCHAIN_PATH:-}" && -f "${KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

      - name: Upload DMG
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: Oahu-${{ matrix.runtime }}-dmg
          path: ./artifacts/*.dmg
          retention-days: 30

  build-windows:
    strategy:
      matrix:
        include:
          - runtime: win-x64
            label: Windows-x64
          - runtime: win-arm64
            label: Windows-ARM64

    name: Build ${{ matrix.label }}
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Restore dependencies
        working-directory: src
        run: dotnet restore Oahu.Avalonia.slnf

      - name: Build
        working-directory: src
        run: dotnet build Oahu.Avalonia.slnf --configuration Release --no-restore

      - name: Publish app
        run: |
          ./build/build-windows.ps1 `
            -Configuration Release `
            -Runtime ${{ matrix.runtime }} `
            -OutputDir ./artifacts `
            -AvaloniaApp `
            -CreateInstaller

      - name: Upload installer
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: Oahu-${{ matrix.runtime }}-installer
          path: ./artifacts/installer/*.exe
          retention-days: 30

  build-linux:
    strategy:
      matrix:
        include:
          - runtime: linux-x64
            label: Linux-x64
          - runtime: linux-arm64
            label: Linux-ARM64

    name: Build ${{ matrix.label }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Restore dependencies
        working-directory: src
        run: dotnet restore Oahu.Avalonia.slnf

      - name: Build
        working-directory: src
        run: dotnet build Oahu.Avalonia.slnf --configuration Release --no-restore

      - name: Publish and package
        run: |
          chmod +x ./build/build-linux.sh
          ./build/build-linux.sh \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --output ./artifacts

      - name: Upload tarball
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: Oahu-${{ matrix.runtime }}-tarball
          path: ./artifacts/*.tar.gz
          retention-days: 30

  release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets

      - name: List assets
        run: find ./release-assets -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            ./release-assets/**/*.dmg
            ./release-assets/**/*-Setup.exe
            ./release-assets/**/*.tar.gz